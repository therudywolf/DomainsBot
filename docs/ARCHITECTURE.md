# Архитектура BotTGDomains

## Обзор системы

BotTGDomains - это асинхронный Telegram бот для проверки и мониторинга доменов, построенный на базе `aiogram 3.x` и использующий Docker Compose для развертывания.

## Компоненты системы

### 1. Telegram Bot (`tg_domain_scanner_final/`)

**Основной модуль:** `bot.py`

**Ответственность:**
- Обработка команд и сообщений от пользователей
- Управление состоянием (FSM)
- Формирование отчетов и отправка их пользователям
- Управление доступом и разрешениями
- Админ-панель

**Ключевые модули:**
- `bot.py` - основной файл с обработчиками
- `config.py` - конфигурация приложения
- `utils/` - вспомогательные модули

---

### 2. Утилиты (`tg_domain_scanner_final/utils/`)

#### `dns_utils.py`
Получение DNS записей (A, AAAA, MX, NS).

**Зависимости:**
- `dnspython` для DNS запросов

#### `ssl_utils.py`
Проверка SSL/TLS сертификатов, включая GOST.

**Особенности:**
- Поддержка обычных и GOST сертификатов
- Получение дат действия обоих типов сертификатов
- Retry механизм для надежности

**Зависимости:**
- `aiohttp` для HTTP запросов
- Внешний сервис `GostSSLCheck` для проверки GOST

#### `waf_utils.py`
Проверка наличия WAF (Web Application Firewall).

**Режимы проверки:**
- **Policy** - проверка через `/?monitoring=test_query_for_policy`
- **Light** - легкая проверка через простой GET запрос
- **Injection** - проверка через отправку тестовых инъекций

**Модули:**
- `waf_utils.py` - основная логика
- `waf_light_check.py` - легкая проверка
- `waf_injection_check.py` - проверка через инъекции

#### `domain_normalizer.py`
Нормализация доменных имен из различных форматов.

**Поддерживает:**
- URL с протоколами (http://, https://)
- URL с путями и параметрами
- Домены с портами
- Простые домены

#### `formatting.py`
Форматирование отчетов для Telegram.

**Функции:**
- `build_report()` - формирование отчета
- `build_report_keyboard()` - создание интерактивных кнопок

#### `monitoring.py`
Система мониторинга доменов.

**Функциональность:**
- Добавление/удаление доменов
- Периодическая проверка изменений
- Отправка уведомлений при изменениях
- Параллельная обработка доменов

**Хранение:** `data/monitoring_db.json`

#### `cache.py`
Кэширование результатов проверок.

**Особенности:**
- TTL кэш на основе shelve
- In-memory LRU кэш для горячих данных
- Fallback на in-memory при проблемах с файлом
- Метрики hit/miss rate

**Хранение:** `data/domain_cache.db`

#### `rate_limiter.py`
Ограничение частоты запросов.

**Алгоритм:** Sliding window

**Типы лимитов:**
- Обычные операции: 30 запросов/минуту
- Тяжелые операции: 10 запросов/минуту
- Загрузка файлов: 5 запросов/5 минут

**Дополнительно:**
- Временная блокировка при превышении лимита (5 минут)

#### `stats.py`
Сбор статистики использования.

**Метрики:**
- Количество проверенных доменов
- Количество пользователей
- Популярные домены
- Активность по часам суток
- Типы ошибок
- Метрики производительности (среднее, медиана, p95, p99)
- Статистика кэша

**Хранение:** `data/stats.json`

#### `history.py`
История проверок доменов.

**Функции:**
- Сохранение результатов проверок
- Получение истории по домену или пользователю
- Очистка старых записей

**Хранение:** `data/check_history.json`

#### `prefs.py`
Хранение пользовательских настроек.

**Настройки:**
- Режим отчета (full/brief)
- Режим проверки WAF (policy/light)
- Таймаут WAF

**Хранение:** `data/user_prefs.db` (shelve)

#### `file_utils.py`
Async-safe операции с файлами.

**Функции:**
- `async_read_json()` - асинхронное чтение JSON
- `async_write_json()` - асинхронная запись JSON
- `async_read_text()` - асинхронное чтение текста
- `async_write_text()` - асинхронная запись текста

#### `buffered_writer.py`
Буферизованная запись в файлы.

**Особенности:**
- Batch writes для оптимизации
- Периодическое сохранение
- Принудительное сохранение при достижении лимита буфера

#### `error_logging.py`
Улучшенное логирование ошибок.

**Функции:**
- Генерация уникальных ID для ошибок
- Структурированное логирование (JSON)
- Контекст пользователя
- Алерты для критических ошибок

---

### 3. Gost SSL Check Service (`GostSSLCheck/`)

**Компоненты:**
- `server.py` - HTTP сервер для проверки GOST сертификатов
- `check.sh` - скрипт проверки с использованием OpenSSL и gost-engine
- `Dockerfile` - образ контейнера

**Протокол:**
- HTTP запрос: `GET /check?domain=example.com`
- Ответ: `{"gost": true/false}`

**Особенности:**
- Health check endpoint (`/health`)
- Валидация доменов
- Детальное логирование
- Graceful shutdown

---

## Потоки данных

### Проверка домена

```
Пользователь → Bot → Параллельные запросы:
                    ├─ DNS (dns_utils)
                    ├─ SSL (ssl_utils)
                    └─ WAF (waf_utils)
                    ↓
                Формирование отчета (formatting)
                    ↓
                Сохранение в историю (history)
                    ↓
                Запись статистики (stats)
                    ↓
                Отправка пользователю
```

### Мониторинг доменов

```
Мониторинг цикл (каждую минуту)
    ↓
Проверка интервалов для каждого домена
    ↓
Параллельная проверка доменов (семафор)
    ↓
Сравнение с предыдущим состоянием
    ↓
Генерация уведомлений при изменениях
    ↓
Отправка уведомлений пользователям
```

---

## Хранение данных

### JSON файлы
- `data/access_db.json` - список пользователей и разрешений
- `data/monitoring_db.json` - домены в мониторинге
- `data/stats.json` - статистика использования
- `data/check_history.json` - история проверок

### Shelve базы данных
- `data/domain_cache.db` - кэш результатов проверок
- `data/user_prefs.db` - пользовательские настройки

---

## Безопасность

### Валидация входных данных
- Проверка длины доменов (максимум 253 символа)
- Валидация user_id (только положительные числа)
- Защита от инъекций в именах файлов
- Ограничение размера текстовых сообщений (100 KB)

### Rate Limiting
- Разные лимиты для разных типов операций
- Временная блокировка при превышении лимита
- Sliding window алгоритм

### Защита от DoS
- Проверка размера файла до загрузки
- Ограничение количества одновременных проверок (семафор)
- Таймауты для всех операций

---

## Производительность

### Оптимизации
- Параллельная обработка доменов (asyncio.gather)
- Кэширование результатов (TTL кэш)
- Буферизованная запись в файлы
- In-memory LRU кэш поверх shelve

### Метрики
- Время выполнения проверок (среднее, медиана, p95, p99)
- Hit rate кэша
- Размер кэша
- Нагрузка на систему

---

## Масштабирование

### Текущая архитектура
- Однопоточный event loop (asyncio)
- In-memory rate limiting
- Локальное хранение данных (JSON, shelve)

### Возможные улучшения
- Распределенный rate limiting (Redis)
- База данных вместо JSON файлов (PostgreSQL, MongoDB)
- Горизонтальное масштабирование (несколько инстансов бота)
- Очередь задач для мониторинга (Celery, RabbitMQ)

---

## Развертывание

### Docker Compose

**Сервисы:**
1. `tgscanner` - основной бот
2. `gostsslcheck` (x2) - сервисы проверки GOST сертификатов

**Volumes:**
- `data/` - персистентные данные

**Health Checks:**
- Все сервисы имеют health check endpoints

---

## Логирование

### Уровни логирования
- DEBUG - детальная информация для отладки
- INFO - общая информация о работе
- WARNING - предупреждения
- ERROR - ошибки
- CRITICAL - критические ошибки

### Формат логов
- Консоль: читаемый формат с временными метками
- Файл: ротация логов (10 MB, 5 копий)

### Структурированное логирование
- JSON формат для парсинга
- Traceback ID для отслеживания ошибок
- Контекст пользователя в логах

---

## Мониторинг и алерты

### Health Check
Команда `/health` проверяет:
- Доступность кэша
- Работу статистики
- Состояние мониторинга
- Работу rate limiter
- Доступность Gost сервисов

### Алерты администратору
- Критические ошибки (каждый час)
- Превышение лимитов использования
- Проблемы с компонентами системы

---

## Обработка ошибок

### Graceful Degradation
- Fallback для каждого компонента (DNS, SSL, WAF, GOST)
- Частичные результаты при частичных сбоях
- Понятные сообщения об ошибках для пользователей

### Retry механизмы
- Gost проверка: 3 попытки с задержкой
- Кэш операции: 3 попытки с экспоненциальной задержкой

---

## Зависимости

### Основные библиотеки
- `aiogram` 3.x - Telegram Bot API
- `aiohttp` - асинхронные HTTP запросы
- `dnspython` - DNS запросы
- `python-dotenv` - загрузка переменных окружения

### Системные требования
- Python 3.10+
- Docker и Docker Compose
- OpenSSL с gost-engine (в контейнере GostSSLCheck)

---

## Будущие улучшения

1. **База данных:** Замена JSON файлов на PostgreSQL
2. **Распределенный rate limiting:** Redis для масштабирования
3. **Очередь задач:** Celery для фоновых задач
4. **Веб-интерфейс:** Dashboard для администратора
5. **API:** REST API для интеграций
6. **Тестирование:** Unit и интеграционные тесты





